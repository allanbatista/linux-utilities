#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f -- "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(dirname -- "$SCRIPT_PATH")"
PROJECT_DIR="$(dirname -- "$SCRIPT_DIR")"

show_help() {
    echo "ab git - Git utilities powered by LLM"
    echo ""
    echo "Usage: ab git <command> [arguments...]"
    echo ""
    echo "Commands:"
    echo "  auto-commit       Generate commit message via LLM"
    echo "  pr-description    Generate PR title/description via LLM"
    echo "  rewrite-history   Rewrite commit messages via LLM"
    echo ""
    echo "Use 'ab git <command> --help' for more details"
}

if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

COMMAND="$1"
shift

# Python path setup
VENV_PYTHON="$PROJECT_DIR/.venv/bin/python"
export PYTHONPATH="$PROJECT_DIR/src"

run_python() {
    if [[ -x "$VENV_PYTHON" ]]; then
        exec "$VENV_PYTHON" -m "$@"
    else
        exec /usr/bin/python3 -m "$@"
    fi
}

case "$COMMAND" in
    help|-h|--help)
        show_help
        ;;
    auto-commit)
        run_python ab_cli.commands.auto_commit "$@"
        ;;
    pr-description)
        run_python ab_cli.commands.pr_description "$@"
        ;;
    rewrite-history)
        run_python ab_cli.commands.rewrite_history "$@"
        ;;
    *)
        echo "Error: unknown git command '$COMMAND'"
        echo "Use 'ab git help' to see available commands"
        exit 1
        ;;
esac
