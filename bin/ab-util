#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f -- "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(dirname -- "$SCRIPT_PATH")"
PROJECT_DIR="$(dirname -- "$SCRIPT_DIR")"

show_help() {
    echo "ab util - General utilities"
    echo ""
    echo "Usage: ab util <command> [arguments...]"
    echo ""
    echo "Commands:"
    echo "  explain           Explain code, errors, or concepts via LLM"
    echo "  gen-script        Generate scripts from natural language"
    echo "  passgenerator     Secure password generator"
    echo ""
    echo "Use 'ab util <command> --help' for more details"
}

if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

COMMAND="$1"
shift

case "$COMMAND" in
    help|-h|--help)
        show_help
        ;;
    explain)
        # Python path setup
        VENV_PYTHON="$PROJECT_DIR/.venv/bin/python"
        export PYTHONPATH="$PROJECT_DIR/src"
        if [[ -x "$VENV_PYTHON" ]]; then
            exec "$VENV_PYTHON" -m ab_cli.commands.explain "$@"
        else
            exec /usr/bin/python3 -m ab_cli.commands.explain "$@"
        fi
        ;;
    gen-script|script)
        # Python path setup
        VENV_PYTHON="$PROJECT_DIR/.venv/bin/python"
        export PYTHONPATH="$PROJECT_DIR/src"
        if [[ -x "$VENV_PYTHON" ]]; then
            exec "$VENV_PYTHON" -m ab_cli.commands.gen_script "$@"
        else
            exec /usr/bin/python3 -m ab_cli.commands.gen_script "$@"
        fi
        ;;
    passgenerator)
        exec "$PROJECT_DIR/scripts/passgenerator" "$@"
        ;;
    *)
        echo "Error: unknown util command '$COMMAND'"
        echo "Use 'ab util help' to see available commands"
        exit 1
        ;;
esac
