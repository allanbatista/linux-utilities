#!/usr/bin/env bash

usage() {
    echo "Usage: $0 N [options]"
    echo "  N: password length (required)"
    echo "Options:"
    echo "  --no-letters        Do not include letters (A-Z, a-z)"
    echo "  --no-digits         Do not include numbers (0-9)"
    echo "  --no-punct          Do not include punctuation (!@#...)"
    echo "  --min-letters M     Minimum number of letters"
    echo "  --min-digits M      Minimum number of numbers"
    echo "  --min-punct M       Minimum number of punctuation marks"
    echo "  --allow-sequences   Allow sequences (abc, 123, etc.)"
    echo "  --allow-repeated    Allow same character repetition (ex: aaa, 111)"
    exit 1
}

# --- Default parameters ---
LENGTH="$1"
shift || true

[[ -z "$LENGTH" ]] && usage

LETTERS="A-Za-z"
DIGITS="0-9"
PUNCT="!@#$%^&*()-_=+[]{};:,.<>?/"

INCLUDE_LETTERS=true
INCLUDE_DIGITS=true
INCLUDE_PUNCT=true

MIN_LETTERS=0
MIN_DIGITS=0
MIN_PUNCT=0
ALLOW_SEQUENCES=false
ALLOW_REPEATED=false

# --- Process parameters ---
while [[ $# -gt 0 ]]; do
    case "$1" in
        --no-letters) INCLUDE_LETTERS=false ;;
        --no-digits) INCLUDE_DIGITS=false ;;
        --no-punct) INCLUDE_PUNCT=false ;;
        --min-letters) MIN_LETTERS="$2"; shift ;;
        --min-digits) MIN_DIGITS="$2"; shift ;;
        --min-punct) MIN_PUNCT="$2"; shift ;;
        --allow-sequences) ALLOW_SEQUENCES=true ;;
        --allow-repeated) ALLOW_REPEATED=true ;;
        *) usage ;;
    esac
    shift
done

CHARSET=""
$INCLUDE_LETTERS && CHARSET+="$LETTERS"
$INCLUDE_DIGITS && CHARSET+="$DIGITS"
$INCLUDE_PUNCT && CHARSET+="$PUNCT"

if [[ -z "$CHARSET" ]]; then
    echo "Error: No character set selected."
    exit 1
fi

# Function to check letter/number sequences
contains_sequence() {
    local pass="$1"
    if [[ "$pass" =~ (abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|jkl|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz|012|123|234|345|456|567|678|789) ]]; then
        return 0
    fi
    return 1
}

# Function to check same character repetition
contains_repeated() {
    local pass="$1"
    if [[ "$pass" =~ (.)\1\1 ]]; then  # Three repetitions of same character
        return 0
    fi
    return 1
}

# Function to generate password
generate_password() {
    local pwd=""
    while true; do
        pwd=$(< /dev/urandom tr -dc "$CHARSET" | head -c "$LENGTH")

        # Check minimum quantities
        [[ $(grep -o "[A-Za-z]" <<< "$pwd" | wc -l) -lt "$MIN_LETTERS" ]] && continue
        [[ $(grep -o "[0-9]" <<< "$pwd" | wc -l) -lt "$MIN_DIGITS" ]] && continue
        [[ $(grep -o "[$PUNCT]" <<< "$pwd" | wc -l) -lt "$MIN_PUNCT" ]] && continue

        # Block sequences (unless allowed)
        ! $ALLOW_SEQUENCES && contains_sequence "$pwd" && continue

        # Block same character repetitions (unless allowed)
        ! $ALLOW_REPEATED && contains_repeated "$pwd" && continue

        echo "$pwd"
        break
    done
}

generate_password
